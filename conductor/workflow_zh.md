# 專案工作流程

## 指導原則

1.  **計畫即真理：** 所有工作必須在 `plan.md` 中追蹤。
2.  **技術堆疊需深思熟慮：** 對技術堆疊的變更必須在實作*之前*記錄在 `tech-stack.md` 中。
3.  **測試驅動開發 (TDD)：** 在實作功能之前編寫單元測試。
4.  **高程式碼覆蓋率：** 所有模組的程式碼覆蓋率目標為 >80%。
5.  **使用者體驗優先：** 每個決定都應優先考慮使用者體驗。
6.  **非互動式與 CI 感知：** 偏好非互動式指令。對監控模式工具（測試、linter）使用 `CI=true` 以確保單次執行。

## 任務工作流程

所有任務遵循嚴格的生命週期：

### 標準任務工作流程

1.  **選擇任務：** 依序從 `plan.md` 選擇下一個可用任務。

2.  **標記進行中：** 開始工作前，編輯 `plan.md` 將任務從 `[ ]` 變更為 `[~]`。

3.  **編寫失敗測試（紅燈階段）：**
    - 為功能或錯誤修復建立新的測試檔案。
    - 編寫一個或多個單元測試，清楚定義預期行為和驗收標準。
    - **關鍵：** 執行測試並確認它們如預期失敗。這是 TDD 的「紅燈」階段。在有失敗測試之前，請勿繼續。

4.  **實作以通過測試（綠燈階段）：**
    - 編寫使失敗測試通過所需的最小應用程式碼量。
    - 再次執行測試套件並確認所有測試現在都通過。這是「綠燈」階段。

5.  **重構（可選但推薦）：**
    - 在通過測試的安全網下，重構實作程式碼和測試程式碼以提高清晰度、消除重複並增強效能，而不改變外部行為。
    - 重新執行測試以確保重構後仍然通過。

6.  **驗證覆蓋率：** 使用專案選定的工具執行覆蓋率報告。
    目標：新程式碼 >80% 覆蓋率。

7.  **記錄偏差：** 如果實作與技術堆疊不同：
    - **停止**實作
    - 更新 `tech-stack.md` 為新設計
    - 加入註明解釋變更的日期註釋
    - 恢復實作

8.  **提交程式碼變更：**
    - 暫存所有與任務相關的程式碼變更。
    - 提出清晰、簡潔的提交訊息，例如 `feat(ui): Create basic HTML structure for calculator`。
    - 執行提交。

9.  **使用 Git Notes 附加任務摘要：**
    - **步驟 9.1：取得提交雜湊：** 取得*剛完成提交*的雜湊 (`git log -1 --format="%H"`)。
    - **步驟 9.2：草擬註釋內容：** 為完成的任務建立詳細摘要。應包括任務名稱、變更摘要、所有建立/修改檔案的清單，以及變更的核心「原因」。
    - **步驟 9.3：附加註釋：** 使用 `git notes` 指令將摘要附加到提交。

10. **取得並記錄任務提交 SHA：**
    - **步驟 10.1：更新計畫：** 讀取 `plan.md`，找到完成任務的行，將其狀態從 `[~]` 更新為 `[x]`，並附加*剛完成提交*的雜湊的前 7 個字元。
    - **步驟 10.2：寫入計畫：** 將更新後的內容寫回 `plan.md`。

11. **提交計畫更新：**
    - **行動：** 暫存修改後的 `plan.md` 檔案。
    - **行動：** 使用描述性訊息提交此變更（例如 `conductor(plan): Mark task 'Create user model' as complete`）。

### 階段完成驗證與檢查點協議

**觸發：** 當 `plan.md` 中結束一個階段的任務完成後，立即執行此協議。

1.  **宣布協議開始：** 告知使用者階段已完成，驗證與檢查點協議已開始。

2.  **確保階段變更的測試覆蓋率：**
    -   **步驟 2.1：確定階段範圍：** 讀取 `plan.md` 找到*上一個*階段檢查點的 Git SHA。
    -   **步驟 2.2：列出變更檔案：** 執行 `git diff --name-only <previous_checkpoint_sha> HEAD`。
    -   **步驟 2.3：驗證並建立測試：** 對於清單中的每個程式碼檔案，驗證是否存在對應的測試檔案。如果遺失，**必須**建立一個。

3.  **執行自動化測試與主動除錯：**
    -   執行前，**必須**宣布將使用的確切 Shell 指令。
    -   執行指令。如果測試失敗，**必須**通知使用者並開始除錯（最多嘗試修復兩次）。

4.  **提出詳細、可執行的手動驗證計畫：**
    -   **關鍵：** 分析 `product.md`、`product-guidelines.md` 和 `plan.md` 以確定使用者面向的目標。
    -   **必須**產生一步步的計畫，引導使用者完成驗證過程。
    -   計畫必須包含具體指令和預期結果。

5.  **等待明確的使用者回饋：**
    -   詢問使用者：「**這是否符合您的預期？請確認是或提供需要修改的回饋。**」
    -   **暫停**並等待使用者回應。

6.  **建立檢查點提交：**
    -   暫存所有變更。
    -   執行提交（例如 `conductor(checkpoint): Checkpoint end of Phase X`）。

7.  **使用 Git Notes 附加可稽核驗證報告：**
    -   使用 `git notes` 將包含自動化測試指令、手動驗證步驟和使用者確認的詳細報告附加到檢查點提交。

8.  **取得並記錄階段檢查點 SHA：**
    -   更新 `plan.md`，在完成的階段標題後附加 `[checkpoint: <sha>]`。

9.  **提交計畫更新：**
    -   提交 `plan.md` 的變更（例如 `conductor(plan): Mark phase '<PHASE NAME>' as complete`）。

10. **宣布完成：** 告知使用者階段已完成且檢查點已建立。
